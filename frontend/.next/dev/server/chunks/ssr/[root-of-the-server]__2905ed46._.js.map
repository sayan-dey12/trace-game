{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///E:/personal/fun/consent-trace-app/frontend/pages/index.tsx"],"sourcesContent":["import React, { useRef, useState } from \"react\";\r\nimport { QRCodeCanvas } from \"qrcode.react\";\r\n\r\nconst BACKEND = process.env.NEXT_PUBLIC_BACKEND || \"http://localhost:4000\";\r\n\r\nexport default function HomePage() {\r\n  const [trackRes, setTrackRes] = useState<any>(null);\r\n  const [gps, setGps] = useState<string | null>(null);\r\n  const [uploadInfo, setUploadInfo] = useState<any>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const [autoMode, setAutoMode] = useState(false);\r\n  const intervalRef = useRef<number | null>(null); // FIXED TYPE\r\n\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const [stream, setStream] = useState<MediaStream | null>(null);\r\n\r\n  // -------------------- TRACK IP --------------------\r\n  async function handleTrack() {\r\n    const res = await fetch(`${BACKEND}/api/track`);\r\n    const json = await res.json();\r\n    setTrackRes(json);\r\n  }\r\n\r\n  // -------------------- GPS --------------------\r\n  function handleGPS() {\r\n    if (!navigator.geolocation) return setGps(\"Geolocation not supported\");\r\n\r\n    navigator.geolocation.getCurrentPosition(\r\n      (pos) => {\r\n        setGps(`Lat: ${pos.coords.latitude}, Lon: ${pos.coords.longitude}`);\r\n      },\r\n      (err) => setGps(`Denied: ${err.message}`)\r\n    );\r\n  }\r\n\r\n  // -------------------- CAMERA --------------------\r\n  async function openCamera(startAuto = false) {\r\n    try {\r\n      const s = await navigator.mediaDevices.getUserMedia({ video: true });\r\n      setStream(s);\r\n\r\n      if (videoRef.current) {\r\n        videoRef.current.srcObject = s;\r\n        await videoRef.current.play();\r\n      }\r\n\r\n      if (startAuto) startAutoCapture();\r\n    } catch (err: any) {\r\n      alert(\"Camera denied: \" + err.message);\r\n    }\r\n  }\r\n\r\n  // -------------------- TAKE PHOTO --------------------\r\n  async function takePhoto(silent = false) {\r\n    if (!videoRef.current) return;\r\n\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.width = videoRef.current.videoWidth;\r\n    canvas.height = videoRef.current.videoHeight;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    ctx?.drawImage(videoRef.current, 0, 0);\r\n\r\n    const blob = await new Promise<Blob | null>((resolve) =>\r\n      canvas.toBlob(resolve, \"image/jpeg\", 0.9)\r\n    );\r\n\r\n    if (!blob) return alert(\"Could not capture image\");\r\n\r\n    // Get GPS\r\n    const pos = await new Promise<GeolocationPosition | null>((resolve) => {\r\n      navigator.geolocation.getCurrentPosition(\r\n        (p) => resolve(p),\r\n        () => resolve(null)\r\n      );\r\n    });\r\n\r\n    const fd = new FormData();\r\n    fd.append(\"photo\", blob);\r\n    fd.append(\"consent\", \"yes\");\r\n\r\n    if (pos) {\r\n      fd.append(\"latitude\", String(pos.coords.latitude));\r\n      fd.append(\"longitude\", String(pos.coords.longitude));\r\n    }\r\n\r\n    const res = await fetch(`${BACKEND}/api/upload-photo`, {\r\n      method: \"POST\",\r\n      body: fd\r\n    });\r\n\r\n    const json = await res.json();\r\n    setUploadInfo(json);\r\n\r\n    // Stop only in manual mode\r\n    if (!silent && !autoMode && stream) {\r\n      stream.getTracks().forEach((t) => t.stop());\r\n      setStream(null);\r\n    }\r\n  }\r\n\r\n  // -------------------- AUTO CAPTURE EVERY 5 SEC --------------------\r\n  function startAutoCapture() {\r\n    if (autoMode) return;\r\n\r\n    setAutoMode(true);\r\n\r\n    intervalRef.current = window.setInterval(() => {\r\n      takePhoto(true); // silent mode â†’ keeps camera running\r\n    }, 5000);\r\n\r\n    console.log(\"ðŸ“¸ Auto Capture Started\");\r\n  }\r\n\r\n  function stopAutoCapture() {\r\n    setAutoMode(false);\r\n\r\n    if (intervalRef.current !== null) {\r\n      clearInterval(intervalRef.current); // FIXED\r\n      intervalRef.current = null;\r\n    }\r\n\r\n    if (stream) {\r\n      stream.getTracks().forEach((t) => t.stop());\r\n      setStream(null);\r\n    }\r\n\r\n    console.log(\"ðŸ›‘ Auto Capture Stopped\");\r\n  }\r\n\r\n  // -------------------- RUN ALL --------------------\r\n  async function runAll() {\r\n    setLoading(true);\r\n\r\n    await handleTrack();\r\n    handleGPS();\r\n    await openCamera(true); // auto = true â†’ start auto mode\r\n\r\n    // Take 1 initial photo immediately\r\n    setTimeout(async () => {\r\n      await takePhoto(true);\r\n      setLoading(false);\r\n    }, 1000);\r\n  }\r\n\r\n  // -------------------- UI --------------------\r\n  const cardStyle = {\r\n    padding: \"20px\",\r\n    margin: \"20px 0\",\r\n    borderRadius: \"10px\",\r\n    background: \"#ffffff\",\r\n    boxShadow: \"0 0 10px rgba(0,0,0,0.08)\"\r\n  };\r\n\r\n  const buttonStyle = {\r\n    padding: \"12px 20px\",\r\n    marginTop: \"10px\",\r\n    background: \"#0070f3\",\r\n    color: \"white\",\r\n    border: \"none\",\r\n    borderRadius: \"6px\",\r\n    cursor: \"pointer\",\r\n    fontSize: \"16px\"\r\n  };\r\n\r\n  return (\r\n    <main style={{ padding: 20, maxWidth: 800, margin: \"auto\", fontFamily: \"Arial\" }}>\r\n\r\n      <h1 style={{ textAlign: \"center\", marginBottom: 30 }}>\r\n        Consent-Based Data Capture\r\n      </h1>\r\n\r\n      {/* Run All Button */}\r\n      <div style={{ textAlign: \"center\", marginBottom: 40 }}>\r\n        <button\r\n          onClick={runAll}\r\n          style={{ ...buttonStyle, background: \"green\" }}\r\n          disabled={loading}\r\n        >\r\n          {loading ? \"Running...\" : \"Run All (Start Auto Capture)\"}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Stop Auto Capture */}\r\n      {autoMode && (\r\n        <div style={{ textAlign: \"center\", marginBottom: 20 }}>\r\n          <button\r\n            onClick={stopAutoCapture}\r\n            style={{ ...buttonStyle, background: \"red\" }}\r\n          >\r\n            Stop Auto Capture\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* IP + Device */}\r\n      <section style={cardStyle}>\r\n        <h2>1. Collect IP + Device Info</h2>\r\n        <button onClick={handleTrack} style={buttonStyle}>\r\n          Log My Info\r\n        </button>\r\n        <pre>{trackRes && JSON.stringify(trackRes, null, 2)}</pre>\r\n      </section>\r\n\r\n      {/* GPS */}\r\n      <section style={cardStyle}>\r\n        <h2>2. Collect GPS Coordinates</h2>\r\n        <button onClick={handleGPS} style={buttonStyle}>\r\n          Share GPS\r\n        </button>\r\n        <pre>{gps}</pre>\r\n      </section>\r\n\r\n      {/* Camera */}\r\n      <section style={cardStyle}>\r\n        <h2>3. Camera + Photo Upload</h2>\r\n\r\n        <button onClick={() => openCamera(false)} style={buttonStyle}>\r\n          Open Camera (Manual)\r\n        </button>\r\n\r\n        <button\r\n          onClick={() => openCamera(true)}\r\n          style={{ ...buttonStyle, background: \"purple\", marginLeft: 10 }}\r\n        >\r\n          Start Auto Capture\r\n        </button>\r\n\r\n        <br /><br />\r\n        <video\r\n          ref={videoRef}\r\n          style={{ width: \"100%\", maxWidth: \"350px\", borderRadius: \"10px\" }}\r\n        />\r\n\r\n        <br />\r\n        <button onClick={() => takePhoto(false)} style={buttonStyle}>\r\n          Capture & Upload\r\n        </button>\r\n\r\n        <pre>{uploadInfo && JSON.stringify(uploadInfo, null, 2)}</pre>\r\n      </section>\r\n\r\n      {/* QR Code */}\r\n      <section style={cardStyle}>\r\n        <h2>Shareable QR Code</h2>\r\n        <QRCodeCanvas\r\n          value={typeof window !== \"undefined\" ? window.location.href : \"\"}\r\n          size={200}\r\n        />\r\n      </section>\r\n    </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}